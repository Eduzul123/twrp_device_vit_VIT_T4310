name: Build TWRP for VIT_T4310

on:
  workflow_dispatch:
  push:
    branches:
      - twrp-5.1
  pull_request:
    branches:
      - twrp-5.1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Run Cleanup to Free Space
        uses: rokibhasansagar/slimhub_actions@main

      - name: Install dependencies
        run: |
          sudo apt update
          # Instala Python 2 y Python 3, ccache, Java y dem√°s herramientas necesarias.
          sudo apt install -y repo git-core curl wget python2 python3 python3-pip ccache openjdk-8-jdk
          # Configura 'python' para que apunte a Python 2.
          sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
          sudo update-alternatives --set python /usr/bin/python2

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Initialize TWRP source
        run: |
          mkdir -p ~/twrp && cd ~/twrp
          repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-5.1 --depth=1

      - name: Sync source with limited jobs
        run: |
          cd ~/twrp
          repo sync -j2 --force-sync --no-clone-bundle --no-tags

      - name: Clone device tree
        run: |
          mkdir -p ~/twrp/device/vit
          git clone --depth=1 https://github.com/Eduzul123/twrp_device_vit_VIT_T4310.git ~/twrp/device/vit/VIT_T4310

      - name: Set up environment
        run: |
          export USE_CCACHE=1
          ccache -M 5G
          export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
          export PATH=$JAVA_HOME/bin:$PATH

      - name: Build TWRP
        run: |
          cd ~/twrp
          source build/envsetup.sh
          lunch omni_VIT_T4310-eng
          mka recoveryimage

      - name: Upload recovery image
        uses: actions/upload-artifact@v4
        with:
          name: TWRP-Recovery
          path: ~/twrp/out/target/product/VIT_T4310/recovery.img
