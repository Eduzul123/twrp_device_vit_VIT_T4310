name: Build TWRP for VIT_T4310

on:
  workflow_dispatch:
  push:
    branches:
      - twrp-5.1
  pull_request:
    branches:
      - twrp-5.1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Run Cleanup to Free Space
        uses: rokibhasansagar/slimhub_actions@main

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y repo git-core curl wget python3

      - name: Checkout source
        uses: actions/checkout@v4

      - name: Initialize TWRP source
        run: |
          mkdir ~/twrp && cd ~/twrp
          repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git -b twrp-5.1 --depth=1

      - name: Sync source with limited jobs
        run: |
          cd ~/twrp
          repo sync -j2 --force-sync --no-clone-bundle --no-tags

      - name: Clone device tree
        run: |
          cd ~/twrp/device
          git clone --depth=1 https://github.com/Eduzul123/twrp_device_vit_VIT_T4310.git vit/VIT_T4310

      - name: Set up ccache
        run: |
          export USE_CCACHE=1
          ccache -M 5G

      - name: Build TWRP
        run: |
          cd ~/twrp
          source build/envsetup.sh
          lunch omni_VIT_T4310-eng
          mka recoveryimage

      - name: Upload recovery image
        uses: actions/upload-artifact@v4
        with:
          name: TWRP-Recovery
          path: ~/twrp/out/target/product/VIT_T4310/recovery.img
