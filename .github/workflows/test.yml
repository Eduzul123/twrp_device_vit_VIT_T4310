name: TWRP Recovery Builder

on:
  workflow_dispatch:
  push:
    branches: [ main ]
  pull_request:

env:
  REPO_URL: https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni
  REPO_BRANCH: twrp-5.1
  DEVICE_NAME: VIT_T4310
  DEVICE_TREE_URL: https://github.com/Eduzul123/twrp_device_vit_VIT_T4310/
  DEVICE_TREE_BRANCH: twrp-5.1
  DEVICE_PATH: device/vit/VIT_T4310
  MAKE_TARGET: recovery
  MAKEFILE_NAME: omni_VIT_T4310

jobs:
  build:
    name: Build TWRP for ${{ env.DEVICE_NAME }}
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set Up Environment
      run: |
        sudo apt-get update -y
        sudo apt-get install -y git-core python3 python3-pip repo \
            openjdk-11-jdk bc bison build-essential ccache curl flex \
            g++-multilib gcc-multilib liblz4-tool libssl-dev libxml2 \
            libxml2-utils lzop m4 pngcrush rsync schedtool squashfs-tools \
            xsltproc zip zlib1g-dev

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Initialize Repo
      run: |
        mkdir -p twrp && cd twrp
        repo init -u ${{ env.REPO_URL }} -b ${{ env.REPO_BRANCH }} --depth=1

    - name: Add Device Tree
      run: |
        cd twrp
        mkdir -p .repo/local_manifests
        cat > .repo/local_manifests/device_manifest.xml << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <project 
            path="${{ env.DEVICE_PATH }}" 
            name="${{ env.DEVICE_TREE_URL }}" 
            remote="github" 
            revision="${{ env.DEVICE_TREE_BRANCH }}" />
        </manifest>
        EOF
        repo sync -j$(nproc) --force-sync --no-clone-bundle --no-tags

    - name: Set Up CCache
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ env.DEVICE_NAME }}-${{ hashFiles('twrp/${{ env.DEVICE_PATH }}/**') }}

    - name: Build Recovery
      run: |
        cd twrp
        source build/envsetup.sh
        lunch ${{ env.MAKEFILE_NAME }}-eng
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 20G
        mka ${{ env.MAKE_TARGET }} -j$(nproc)

    - name: Upload Recovery Image
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: twrp-${{ env.DEVICE_NAME }}-recovery
        path: twrp/out/target/product/${{ env.DEVICE_NAME }}/recovery.img
